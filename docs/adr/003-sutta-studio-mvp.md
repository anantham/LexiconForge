# ADR-003: Sutta Studio MVP + Deep Loom IR + Compiler Pipeline

**Date:** 2026-01-26  
**Status:** Proposed  
**Authors:** Aditya + Codex

## Context

LexiconForge currently renders chapters in a “Reader” mode optimized for flow reading.  
We want a dedicated full-screen **Sutta Studio** for embodied study of the Dhamma:

- quiet UI, minimal chrome
- polysemy is a first-class feature (click words → rotate senses)
- English scaffolding (“ghost words”) is shown as a UI artifact, not source truth
- morphology is visible on interaction (word parts + inflection cues)
- grammar relations appear on interaction, not constantly

InterfaceIdea proved the UI mechanics with a static dataset, but the dataset must become dynamic:
- SuttaCentral is canonical
- analysis is generated by an LLM pipeline into a structured IR
- IR can be rerun later as models improve

## Goals (MVP)

- Dedicated `/sutta/:uid` route (full-screen, scrollable, calm).
- SuttaCentral only (no general chapter support yet).
- English visible by default.
- Ghost words always visible at ~30% opacity, non-selectable.
- Polysemy rotator + ripple adjustments always enabled.
- Morphology segmentation included (even if imperfect).
- Grammar palette + relation tethers behind a single toggle (default ON).
- Replace hardcoded DATASET with a loader that consumes IR JSON.

## Non-Goals (Deferred)

- Always-on grammar graphs
- “Biological jigsaw” connector shapes
- Automated citation retrieval (store citation IDs only)
- Cross-sutta linking / parallels map
- Multi-chapter stitching and retrieval augmentation

## Decision

### UI Integration
- Implement Sutta Studio as a dedicated route: `/sutta/:uid`.
- Reader may provide a minimal entry point (“Open in Sutta Studio”) later.
- No settings gear in the MVP. One toggle only (unlabeled).

### Data Model
- **Hybrid IR**:
  - Canonical source segments keyed to SuttaCentral segment IDs (immutable text).
  - Derived “phase views” (Deep Loom) for UI rendering.
- IR is embedded inside Chapter records (MVP).
- Citations live in a separate registry; senses reference citation IDs.

### LLM Pipeline
Use CSP-style compiler pipeline:  
**Skeleton → Phase Deltas → Validator**

1) **Skeleton pass**: phases, anchors, ghost scaffolding, rough senses.  
2) **Phase deltas**: segmentation, senses, relations, ripple rules.  
3) **Validator**: repair references, enforce schema, list unresolved.

## Options Considered

### UI Location
A) Embed in Reader  
Pros: fewer routes  
Cons: overwhelms flow reading  

B) Reader mode toggle  
Pros: single page  
Cons: still mixes “study cockpit” into reading  

C) Dedicated route (Chosen)  
Pros: clean separation; studio can be bold without clutter  
Cons: requires routing + loader

### IR Shape
A) Phase-first only (mirror UI)  
Pros: fastest to ship  
Cons: poor canonical alignment; hard to reuse  

B) Segment-first only (canonical)  
Pros: stable  
Cons: UI projection is harder  

C) Hybrid (Chosen)  
Pros: stable source alignment + UI-friendly derived views  
Cons: needs projection + mapping metadata

### Pipeline Shape
A) Single-pass compilation  
Pros: simplest  
Cons: weaker coherence, harder to debug  

B) Skeleton → Deltas → Validator (Chosen)  
Pros: coherent, incremental, debuggable, rerunnable  
Cons: more orchestration  

C) Clause microcalls + linker  
Pros: maximum control  
Cons: expensive and complex for MVP

## Consequences

### Positive
- Minimal, elegant study experience without cluttering the main reader.
- IR can be regenerated as models improve.
- Pipeline is incremental and debuggable.

### Negative
- Chapter schema grows; export/import may require a migration path.
- MVP is limited to SuttaCentral.
- Embedded IR increases chapter payload size.

## Implementation Plan (MVP)

1) Add `/sutta/:uid` route and mount the Sutta Studio engine.  
2) Modularize InterfaceIdea into reusable components and types.  
3) Add IR loader (embedded in Chapter) and render the derived phase view.  
4) Stub compiler pipeline (skeleton → deltas → validator) for later connection.  

## Risks & Mitigations

- **Coherence drift across incremental calls**  
  Mitigate with CSP + validator pass.

- **Hallucinated citations**  
  Store only citation IDs; retrieval is a later pass.

- **Latency/cost**  
  Cache compiled packets and rerun only when needed.

## Success Criteria (MVP)

- A SuttaCentral sutta renders in Sutta Studio with:
  - Pali line, English scaffold, polysemy rotator + ripples.
  - Ghost words always visible at ~30% opacity.
  - Grammar toggle reveals suffix coloring, tooltips, and relation tethers.
- IR is dynamically loaded (not hardcoded), and rerunnable later by compiler version.

## Related Docs
- `interfaceIdea.tsx` (prototype UI)
- `docs/sutta-studio/IR.md`
- `docs/ARCHITECTURE.md`
- `docs/WORKLOG.md`
